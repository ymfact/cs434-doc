# csc434-doc/design.md

## Record

Record 타입은 두 개가 되어 불필요한 캐스팅을 막는다.

본래 Array, ByteString, Stream 각각으로부터 얻은 레코드를 클래스 세 개로 만드려 했다. 세 곳에서 얻은 레코드는 불필요한 캐스팅을 막기 위해 클래스를 나눌 필요가 있었다.

Array에서 가져온 애들은 사실상 포인터로서, RecordArray로부터 분리되는 메모리를 갖지 않는다. 파일로부터 어레이를 읽어온 뒤, in-memory 정렬 중에 비교 연산자, 대입 연산자를 사용하기 위해 비교할 때마다 생성하여 사용하였다. 하지만 효용성에 비해 오버헤드가 크다고 판단하여, `RecordArray::compareRecord`, `RecordArray::patchInPlace` 가 되었다.

Tip: ByteString은 substring 코스트가 없다.

## Merge sort

재귀를 사용하지 않는다.

nlogn의 머지소트는 과정 중에 별도의 추가공간 n개가 필요하다. Conquer 매번마다 데이터는 원래 공간과 추가 공간을 번갈아가며 이동한다. 하지만 재귀를 사용한 머지소트는 데이터 위치에 따라 Conqure 횟수가 달라질 수 있다. 결과적으로 데이터가 최종적으로 추가공간에 있는지, 아니면 원래 공가넹 있는지가 데이터 위치마다 달라지는 현상이 생길 수 있고, 이를 막기 위해 재귀가 아닌 스텝마다의 정렬을 사용하게 되었다.

## Parallel Collections

지금 코드에는 메모리 사용량을 의식하지 않은 과도한 병렬화를 해놓았다. 자칫 메모리가 터져서 데드락 먹을지도 모른다. 언젠간 메모리 제한을 먹이거나, par 키워드를 지우자.
